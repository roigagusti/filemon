<!DOCTYPE html>
<html lang="es">

<head>
    <!-- Meta data -->
    {% include 'sections/metadata.html' %}

    <!-- Títol i Favicons -->
    <title>Filemon. Solicitar SKU</title>

    <!-- CSS Libraries -->
    <link rel="stylesheet" href="//www.mesural.com/lib/bootstrap/bootstrap.css">
        
    <link href="//011h.agustiroig.com/assets/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="//011h.agustiroig.com/assets/css/icons.min.css" rel="stylesheet" type="text/css" />
    <link href="//011h.agustiroig.com/assets/css/app.min.css" rel="stylesheet" type="text/css" />

    <link href="//011h.agustiroig.com/assets/libs/select2/css/select2.min.css" rel="stylesheet" type="text/css">
    <link href="//011h.agustiroig.com/assets/libs/bootstrap-colorpicker/css/bootstrap-colorpicker.min.css" rel="stylesheet">
    <link href="//011h.agustiroig.com/assets/libs/bootstrap-datepicker/css/bootstrap-datepicker.min.css" rel="stylesheet">
    <link href="//011h.agustiroig.com/assets/libs/bootstrap-touchspin/jquery.bootstrap-touchspin.min.css" rel="stylesheet">
    
    <!-- CSS Custom -->
    <link rel="stylesheet" type="text/css" href="{{ url_for("static", filename="css/style.css") }}" media="screen">
    <link rel="stylesheet" type="text/css" href="{{ url_for("static", filename="css/responsive.css") }}" media="screen">
    <link rel="stylesheet" type="text/css" href="{{ url_for("static", filename="css/011h.css") }}" media="screen">

    <!-- Scripts Libraries -->
    <script src="//011h.agustiroig.com/lib/bootstrap/js/bootstrap.js"></script>
    <!-- Scripts custom -->
</head>

<body>
    {% include 'sections/header.html' %}
    <!-- Contingut de pàgina -->
    <div class="content">
        <div id="layout-wrapper">
            <div class="page-content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-3">
                            <h1>Materiales</h1>

                            
                            <!-- Quien eres -->
                            <div class="form-group"> 
                                <div class="form-group">
                                    <label for="who" class="form-label mandatory">¿Quién eres?</label>
                                    <select class="form-control" name="who" id="quienEres" style="height: 34px;font-size:14px" required>
                                        <option value="0">Selecciona una opción</option>
                                        {% for name in staff %}
                                            <option value="{{ name }}">{{ name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>                              

                            <!-- Solicitar nuevos SKUs -->
                            <div class="form-group" id="inputSku">
                                <label for="" class="form-label mandatory">Solicitar nuevos SKU</label>
                                <p class="text-muted mb-2">A través del equipo de Supply Chain</p>
                                
                                <a data-toggle="modal" data-target="#addSku"><p class="input-file-text" style="width:60px">
                                    <svg width="12" height="12" viewBox="0 0 12 12" class="flex-none mr-half" style="shape-rendering: geometricPrecision;"><path fill-rule="evenodd" fill="currentColor" d="M9.5,5 L7,5 L7,2.5 C7,2.224 6.776,2 6.5,2 L5.5,2 C5.224,2 5,2.224 5,2.5 L5,5 L2.5,5 C2.224,5 2,5.224 2,5.5 L2,6.5 C2,6.776 2.224,7 2.5,7 L5,7 L5,9.5 C5,9.776 5.224,10 5.5,10 L6.5,10 C6.776,10 7,9.776 7,9.5 L7,7 L9.5,7 C9.776,7 10,6.776 10,6.5 L10,5.5 C10,5.224 9.776,5 9.5,5"></path></svg>
                                    Add
                                </p></a>
                            
                                {% if response %}
                                    {% if response == 'error' %}
                                    <div class='alert alert-danger'>
                                        El SKU no se ha podido solicitar.
                                    </div>
                                    {% else %}
                                    <div class='alert alert-success'>
                                        ¡Solicitado! SKU temporal: <strong>{{ response }}</strong>
                                    </div>
                                    {% endif %}
                                {% endif %}
                                <br>

                                {% include 'sections/requestedSkus.html' %}
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% include 'sections/modal-addSku.html' %}


    <!-- JavaScripts basics -->
    <script src="//011h.agustiroig.com/assets/libs/jquery/jquery.min.js"></script>
    <script src="//011h.agustiroig.com/assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="//011h.agustiroig.com/assets/libs/metismenu/metisMenu.min.js"></script>
    <script src="//011h.agustiroig.com/assets/libs/simplebar/simplebar.min.js"></script>
    <script src="//011h.agustiroig.com/assets/libs/node-waves/waves.min.js"></script>
    <script src="//011h.agustiroig.com/assets/libs/waypoints/lib/jquery.waypoints.min.js"></script>
    <script src="//011h.agustiroig.com/assets/libs/jquery.counterup/jquery.counterup.min.js"></script>

    <script src="//011h.agustiroig.com/assets/libs/apexcharts/apexcharts.min.js"></script>
    <script src="//011h.agustiroig.com/assets/js/pages/dashboard.init.js"></script>
    <script src="//011h.agustiroig.com/assets/js/pages/form-advanced.init.js"></script>
    <script src="//011h.agustiroig.com/assets/libs/select2/js/select2.min.js"></script>
    <script src="//011h.agustiroig.com/assets/libs/bootstrap-colorpicker/js/bootstrap-colorpicker.min.js"></script>
    <script src="//011h.agustiroig.com/assets/libs/bootstrap-datepicker/js/bootstrap-datepicker.min.js"></script>
    <script src="//011h.agustiroig.com/assets/libs/bootstrap-touchspin/jquery.bootstrap-touchspin.min.js"></script>
    <script src="//011h.agustiroig.com/assets/libs/bootstrap-maxlength/bootstrap-maxlength.min.js"></script>
    <script src="//011h.agustiroig.com/assets/js/pages/table-responsive.init.js"></script>
    <!-- JavaScripts custom -->
    
    <script src="//011h.agustiroig.com/assets/js/app.js"></script>
    <script type="text/javascript" src="{{ url_for("static", filename="js/011h.js") }}" ></script>
    <!-- Scripts custom -->
    <script>
    function changeBlur(){
        $("div.responsive-blur").hasClass("hidden") ? $("div.responsive-blur").removeClass("hidden") : $("div.responsive-blur").addClass("hidden");
        $("div.menu").hasClass("hidden") ? $("div.menu").removeClass("hidden") : $("div.menu").addClass("hidden");
    }
    // Copiar quien eres
    $("#quienEres").change(function(){
        var selectedValue = $(this).val();
        $("#mperson").val(selectedValue).attr("content", selectedValue);
        
        var key = 'patTL8BTVtTu5NsaV.fca1e6dcce97d7a5ea038df21d0d808241e87d5bf844167ceea2b1eec3cc81e4';
        var url = 'https://api.airtable.com/v0/appnnVM2i5l7Aj25U/Supply%20SKU%20requests';
        url += '?filterByFormula=' + encodeURIComponent('{requested_by} = "' + selectedValue + '"');
        url += '&fields%5B%5D=status&fields%5B%5D=material_sku&fields%5B%5D=SKU_temporal&fields%5B%5D=material_description1';
        
        fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + key
            }
        })
        .then(response => response.json())
        .then(data => {
            let html = '';
            var i = 0;
            data.records.forEach(record => {
                const status = record.fields.status;
                const sku = status === 'Pending' ? record.fields.SKU_temporal : record.fields.material_sku;
                const description = record.fields.material_description1;
                const statusColor = status === 'Pending' ? 'bg-yellow' : 'bg-green';
                
                html += `<li><a class="list-color ${statusColor}">${sku}</a> ${description}</li>`;
                i++;
            });
            if (i === 0) {
                html = '<li>No hay nada pendiente</li>';
            }
            
            $('#requested-materials').html(html);
        })
        .catch(error => console.error('Error:', error));
    });
    // Comprobar que todos los campos obligatorios estén informados antes de hacer submit
    document.getElementById("form").addEventListener("submit", function(event) {
        var error = false;
        var labels = document.querySelectorAll(".mandatory");
        labels.forEach(function(label) {
            var input = document.querySelector("[name='" + label.getAttribute("for") + "']");
            if (input && input.value === "") {
                error = true;
                input.classList.add("is-invalid");
            }
        });
        if (error) {
            event.preventDefault(); // Prevenir el envío del formulario si hay errores
        }
    });
</script>
</body>
</html>